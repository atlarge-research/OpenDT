<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>OpenDT Digital Twin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Plotly MUST load before index.js -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
<div class="container">
    <!-- Title slate -->
    <header class="header glass sheen lift energy-header">
        <h1>
            <span class="icon" style="--icon-url:var(--sym-gauge)"></span>
            &nbsp;OpenDT Digital Twin Dashboard
        </h1>
        <p class="sub">Real-time datacenter simulation in rolling windows ¬∑ LLM-guided topology optimization</p>
    </header>

    <!-- Controls -->
    <section class="controls glass lift">
        <div class="row">
            <button id="toggleBtn" class="btn btn-primary" onclick="toggleSystem()" data-tip="Start / Stop">
                <span class="icon" style="--icon-url:var(--sym-play)"></span>&nbsp;Start
            </button>

            <div id="statusPill" class="status stopped">
                <span class="dot"></span>
                <strong></strong>
                <span id="statusText">STOPPED</span>
            </div>

            <div class="mode-switch">
                <div class="seg">
                    <button id="btnModeUI" class="active" onclick="setMode('ui')">UI</button>
                    <button id="btnModeJSON" onclick="setMode('json')">JSON</button>
                </div>
            </div>

            <div id="windowPill" class="window-pill pill">Window ‚Äî</div>

            <div class="slo-combo" id="sloCombo">
                <div class="slo-item">
                    <label for="energy_input">Energy [kWh]</label>
                    <input type="number" id="energy_input" class="slo-inline-field" placeholder="10" min="0" step="1">
                </div>
            </div>

            <div class="slo-combo" id="sloCombo">
                <div class="slo-item">
                    <label for="runtime_input">Runtime [h] </label>
                    <input type="number" id="runtime_input" class="slo-inline-field" placeholder="1" min="0.01"
                           step="1">
                </div>
            </div>

            <div class="slo-combo" id="sloCombo">
                <div class="slo-item">
                    <label></label>
                    <span id="bestScore" class="score-value">‚Äî</span>
                </div>
            </div>

            <button id="btnDataLake"
                    class="btn btn-secondary"
                    type="button"
                    onclick="window.dataLake?.open()">
                <span class="icon" style="--icon-url:var(--sym-datalake)"></span>&nbsp;Data Lake
            </button>

        </div>
    </section>

    <!-- Metrics -->
    <section class="metrics">
{#        <div class="metric glass lift sheen">#}
{#            <h3><span class="icon" style="--icon-url:var(--sym-chart)"></span>&nbsp;PROCESSING</h3>#}
{#            <div id="mCycles" class="value">0</div>#}
{#            <div class="meta">Optimization Cycles</div>#}
{#        </div>#}

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-topo)"></span>&nbsp;WORKLOAD</h3>
            <div id="mTasks" class="value">0</div>
            <div class="meta">Current Tasks</div>
        </div>

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-topo)"></span>&nbsp;WORKLOAD</h3>
            <div id="mFragments" class="value">0</div>
            <div class="meta">Current Fragments</div>
        </div>

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-bolt)"></span>&nbsp;ENERGY</h3>
            <div id="mEnergy" class="value">‚Äî</div>
            <div class="meta">kWh Usage</div>
        </div>

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-cpu)"></span>&nbsp;CPU</h3>
            <div id="mCPU" class="value">‚Äî</div>
            <div class="meta">Utilization [%]</div>
        </div>

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-clock)"></span>&nbsp;RUNTIME</h3>
            <div id="mRuntime" class="value">‚Äî</div>
            <div class="meta">Estimated time</div>
        </div>

        <div class="metric glass lift sheen">
            <h3><span class="icon" style="--icon-url:var(--sym-topo)"></span>&nbsp;TOPOLOGY</h3>
            <div id="mTopoUpdates" class="value">0</div>
            <div class="meta">Adjustment(s)</div>
        </div>

{#        <div class="metric glass lift sheen">#}
{#            <h3><span class="icon" style="--icon-url:var(--sym-wand)"></span>&nbsp;LLM</h3>#}
{#            <div id="mLLMAction" class="value">‚Äî</div>#}
{#            <div class="meta" id="mLLMType">‚Äî</div>#}
{#        </div>#}
    </section>

    <!-- Detail cards -->
    <section class="section-columns">
        <section class="section-stack">
            <div class="card glass lift">
                <h3>üó∫Ô∏è Current Topology</h3>
                <div class="ui-only">
                    <table id="currentTopoTable">
                        <thead>
                        <tr>
                            <th>Cluster</th>
                            <th>Host</th>
                            <th>Count</th>
                            <th>Cores</th>
                            <th>Clock (MHz)</th>
                            <th>Memory (GiB)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="6">No topology</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <pre class="json-only" id="currentTopologyJSON">null</pre>
            </div>

            <!-- LLM Recommendation -->
            <div class="card glass lift llm-card">
                <div class="ui-only">
                    <div class="llm-card-header">
                        <div class="llm-card-heading">
                            <h3>ü§ñ LLM Suggested Topology</h3>
                            <p class="llm-card-subtitle">Live recommendations from optimization pipeline</p>
                        </div>
                        <div class="llm-card-header-actions">
                            <span id="llmStatusMessage" class="llm-status-pill" data-state="idle">Awaiting recommendation</span>
                            <div class="llm-action-group">
                                <button id="btnAcceptRec"
                                        class="btn btn-success"
                                        onclick="acceptRecommendation()"
                                        disabled>
                                    <span class="icon" style="--icon-url:var(--sym-check)"></span>&nbsp;Accept
                                </button>
                                <button id="btnEditRec"
                                        class="btn btn-secondary"
                                        onclick="window.recommendationEditor?.startEditing()"
                                        title="Edit recommendation"
                                        aria-label="Edit recommendation"
                                        disabled>
                                    <span class="icon" style="--icon-url:var(--sym-edit)"></span>
                                </button>
                                <button id="btnConfirmRec"
                                        class="btn btn-success btn-icon"
                                        onclick="window.recommendationEditor?.commitEditing()"
                                        hidden
                                        title="Apply edits"
                                        aria-label="Apply edits">
                                    ‚úî
                                </button>
                                <button id="btnCancelRec"
                                        class="btn btn-danger btn-icon"
                                        onclick="window.recommendationEditor?.cancelEditing()"
                                        hidden
                                        title="Discard edits"
                                        aria-label="Discard edits">
                                    ‚úñ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="llm-body-grid">
                        <div class="llm-summary-grid">
                            <div class="llm-summary-item"><span>Action</span><strong id="kvLLMAction">‚Äî</strong></div>
                            <div class="llm-summary-item"><span>Priority</span><span id="kvLLMPriority" class="badge">‚Äî</span></div>
                            <div class="llm-summary-item"><span>Type</span><span id="kvLLMType" class="badge">‚Äî</span></div>
                        </div>

                        <div class="llm-rationale-card">
                            <span class="llm-rationale-label">Rationale</span>
                            <p class="llm-rationale" id="kvLLMReason">‚Äî</p>
                        </div>
                    </div>

                    <div class="llm-table-wrapper">
                        <div class="llm-table-header">
                            <h4>Topology preview</h4>
                            <span class="llm-table-hint">Updated with each accepted change</span>
                        </div>
                        <table id="recTable">
                        <thead>
                        <tr>
                            <th>Cluster</th>
                            <th>Host</th>
                            <th>Count</th>
                            <th>Cores</th>
                            <th>Clock (MHz)</th>
                            <th>Memory (GiB)</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td colspan="6">No recommendation</td>
                        </tr>
                        </tbody>
                        </table>
                    </div>
                </div>
                <pre class="json-only" id="recJSON">null</pre>
                <pre class="json-only" id="llmJSON">null</pre>
            </div>

            <!-- OpenDC Results -->
            <div class="card glass lift">
                <h3>üìà LLM Suggested Topology (simulated)</h3>
                <div class="ui-only">
                    <div class="kv">
                        <div><span>Energy [kWh]</span><strong id="kvEnergy">‚Äî</strong></div>
                        <div><span>Average CPU Utilization [%]</span><strong id="kvCPU">‚Äî</strong></div>
                        <div><span>Runtime [h]</span><strong id="kvRuntime">‚Äî</strong></div>
                        <div><span>LLM feedback for window</span><span id="kvSimType" class="badge">‚Äî</span></div>
                    </div>
                </div>
                <pre class="json-only" id="simJSON">null</pre>
            </div>
        </section>
        <section class="section-stack" aria-label="Charts">
            <!-- Charts (moved aside) -->

            <div class="card glass lift">
                <h3>Average CPU Utilization [%]</h3>

                <!-- chart toolbar -->
                <div class="chart-toolbar">
                    <span class="hint">drag to zoom ¬∑ double-click to reset</span>
                </div>

                <div id="cpu_usages" class="chart"></div>
            </div>

            <div class="card glass lift">
                <h3>Power [kWh]</h3>
                <div class="chart-toolbar">
                    <span class="hint">drag to zoom ¬∑ double-click to reset</span>
                </div>
                <div id="power_usages" class="chart"></div>
            </div>
        </section>
    </section>

    <!-- Best Config -->
    {#    <section class="card glass lift">#}
    {#        <h3>üèÖ Best Configuration</h3>#}
    {#        <div class="ui-only">#}
    {#            <div id="bestScore" class="badge">Score: ‚Äî</div>#}
    {#        </div>#}
    {#        <pre class="json-only" id="bestJSON">null</pre>#}
    {#    </section>#}</div> <!-- /.container -->

<div id="datalakePanel" class="datalake-panel" aria-hidden="true">
    <div class="datalake-card glass lift">
        <header class="datalake-header">
            <h2>üìö Data Lake Explorer</h2>
            <button id="btnCloseDatalake"
                    class="btn btn-close-modal btn-icon"
                    type="button"
                    onclick="window.dataLake?.close()"
                    aria-label="Close data lake">
                ‚úï
            </button>
        </header>
        <div class="datalake-body">
            <aside class="datalake-sidebar">
                <div class="datalake-list-header">
                    <h3>Simulation Runs</h3>
                    <button id="btnRefreshDatalake"
                            class="btn btn-secondary btn-icon"
                            type="button"
                            onclick="window.dataLake?.refresh()"
                            aria-label="Refresh data lake">
                        ‚Üª
                    </button>
                </div>
                <div class="datalake-table-wrapper">
                    <table id="datalakeTable">
                        <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Type</th>
                            <th>Energy</th>
                            <th>Runtime</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr><td colspan="4">No runs recorded</td></tr>
                        </tbody>
                    </table>
                </div>
            </aside>
            <section class="datalake-detail">
                <div class="datalake-metrics" id="datalakeMetrics">
                    <div class="metric-card">
                        <span>Energy [kWh]</span>
                        <strong data-key="energy_kwh">‚Äî</strong>
                    </div>
                    <div class="metric-card">
                        <span>CPU Util [%]</span>
                        <strong data-key="cpu_utilization">‚Äî</strong>
                    </div>
                    <div class="metric-card">
                        <span>Runtime [h]</span>
                        <strong data-key="runtime_hours">‚Äî</strong>
                    </div>
                    <div class="metric-card">
                        <span>Max Power</span>
                        <strong data-key="max_power_draw">‚Äî</strong>
                    </div>
                    <div class="metric-card">
                        <span>Status</span>
                        <strong data-key="status">‚Äî</strong>
                    </div>
                </div>

                <div class="datalake-plots">
                    <div class="datalake-chart">
                        <h4>Power Draw</h4>
                        <div id="datalakePowerChart" class="chart"></div>
                    </div>
                    <div class="datalake-chart">
                        <h4>CPU Utilization</h4>
                        <div id="datalakeCPUChart" class="chart"></div>
                    </div>
                    <div class="datalake-chart">
                        <h4>Service Timeline</h4>
                        <div id="datalakeServiceChart" class="chart"></div>
                    </div>
                </div>

                <div class="datalake-topology">
                    <h4>Topology Snapshot</h4>
                    <pre id="datalakeTopology">Select a run to view topology.</pre>
                </div>
            </section>
        </div>
    </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

<script src="/static/js/utils.js"></script>
<script src="/static/js/recommendations.js"></script>
<script src="/static/js/ui.js"></script>
<script src="/static/js/render.js"></script>
<script src="/static/js/charts.js"></script>
<script src="/static/js/polling.js"></script>
<script src="/static/js/datalake.js"></script>
<script src="/static/js/boot.js"></script>

<script>
    document.body.classList.add('dense-ui');
</script>

</body>
</html>
